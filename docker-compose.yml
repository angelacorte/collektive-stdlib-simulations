version: '3.8'

services:
  prepare:
    image: alpine:3.20.3
    volumes:
      - .:/experiment:rw
    entrypoint: /bin/sh -c
    command:
      - |
        mkdir -p /experiment/data
        chmod 777 /experiment/data

  simulation1:
    build:
      context: .
      dockerfile: ./docker/sim/Dockerfile
    environment:
      MIN: 1.0
      MAX: 5.0
      DEFAULT: 2.0
    depends_on:
      - prepare
    volumes:
      - ./data:/experiment/data

  simulation2:
    build:
      context: .
      dockerfile: ./docker/sim/Dockerfile
    environment:
      MIN: 6.0
      MAX: 10.0
      DEFAULT: 7.0
    depends_on:
      - prepare
    volumes:
      - ./data:/experiment/data

  simulation3:
    build:
      context: .
      dockerfile: ./docker/sim/Dockerfile
    environment:
      MIN: 11.0
      MAX: 15.0
      DEFAULT: 12.0
    depends_on:
      - prepare
    volumes:
      - ./data:/experiment/data

  finish:
    depends_on:
      - prepare
    image: alpine:3.20.3
    volumes:
      - .:/experiment:rw
    entrypoint: /bin/sh -c
    command:
      - |
        find /experiment/data -type d -exec chmod 777 {} \;
        find /experiment/data -type f -exec chmod 666 {} \;